# 「おみくじアプリ」 詳細設計書

---

## 1. システム構成

| モジュール名       | 役割                             |
|--------------------|----------------------------------|
| `main()`           | アプリの起動と制御               |
| `load_data()`      | JSONファイルからデータを読み込む |
| `save_data(data)`  | JSONファイルにデータを保存する   |
| `draw_fortune()`   | 運勢をランダムに抽選する         |

---

## 2. 関数設計

### 2.1 `main()`

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 役割         | アプリの起動、ユーザー入力、抽選処理の制御                          |
| 引数         | なし                                                                 |
| 戻り値       | なし                                                                 |
| 処理概要     | ユーザー名入力 → データ読み込み → 抽選 or 結果表示 → データ保存     |
| 使用関数     | `load_data()`, `save_data(data)`, `draw_fortune()`                    |

---

### 2.2 `load_data()`

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 役割         | JSONファイルからユーザーデータを読み込む                             |
| 引数         | なし                                                                 |
| 戻り値       | dict（ユーザー名をキーとした辞書）                                   |
| 処理概要     | ファイル存在確認 → 読み込み → JSONパース → 辞書として返す           |
| 例外処理     | ファイルが存在しない場合は空の辞書を返す                             |

---

### 2.3 `save_data(data)`

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 役割         | ユーザーデータをJSONファイルに保存                                   |
| 引数         | data（dict型）                                                       |
| 戻り値       | なし                                                                 |
| 処理概要     | `json.dump()` を使って保存                                           |
| 例外処理     | 書き込み失敗時にエラーメッセージ表示                                 |

---

### 2.4 `draw_fortune()`

| 項目         | 内容                                                                 |
|--------------|----------------------------------------------------------------------|
| 役割         | 運勢をランダムに抽選する                                             |
| 引数         | なし                                                                 |
| 戻り値       | str（抽選された運勢）                                                |
| 処理概要     | `random.choice()` を使って運勢リストから1つ選ぶ                     |
| 運勢リスト   | `["大吉", "中吉", "小吉", "吉", "末吉", "凶"]`                         |

---

## 3. データ設計

### 3.1 ファイル構造

- ファイル名：`omikuji_users.json`
- 保存形式：JSON
- データ構造：

```json
{
  "taro": {
    "fortune": "中吉",
    "date": "2025-10-24"
  }
}
```

### 3.2 データ項目

| キー       | 型     | 説明                     |
|------------|--------|--------------------------|
| username   | str    | ユーザー名（キー）       |
| fortune    | str    | 抽選された運勢           |
| date       | str    | 抽選日（YYYY-MM-DD形式） |

---

## 4. 処理フロー

```plaintext
[アプリ起動]
      ↓
[ユーザー名入力]
      ↓
[ユーザーデータ読み込み]
      ↓
[今日の抽選済みか確認]
 ┌───────────────┐
 │ はい          │ → [結果表示]
 └───────────────┘
 │ いいえ        │ → [運勢抽選]
      ↓
[結果保存]
      ↓
[結果表示]
```

---

## 5. 例外処理設計

| ケース                         | 対応方法                             |
|--------------------------------|--------------------------------------|
| ファイルが存在しない           | 空の辞書を返す                       |
| ファイルが破損している         | `try-except` で読み込み失敗を検知   |
| 入力が空文字                   | 再入力を促す                         |
| ファイル書き込み失敗           | エラーメッセージを表示               |
| 日付形式が不正                 | `datetime.now().strftime()` を使用   |

---

## 6. テスト観点

| テスト項目                     | 期待結果                             |
|--------------------------------|--------------------------------------|
| 新規ユーザー登録               | 正常に登録され、抽選結果が表示される |
| 同日再アクセス                 | 保存された結果が表示される           |
| 翌日アクセス                   | 新しい抽選が行われる                 |
| ファイルが存在しない場合       | 新規作成され、正常に動作する         |
| ファイルが破損している場合     | エラー処理され、空データで動作する   |
| 運勢の抽選                     | 6種類のいずれかが表示される          |

